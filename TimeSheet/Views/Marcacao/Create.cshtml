@model TimeSheet.ViewModel.ViewModelMacacao

@{
    ViewData["Title"] = "Marcações Diárias";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@using (Html.BeginForm())
{
    <div id="top" class="my-row">
        <div class="col-md-12">
            <div class="card azulc-azule">
                <div class="card-header">
                    @ViewBag.Title
                </div>
                <div class="card-body">
                    @Html.AntiForgeryToken()
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    <div class="row">
                        <div class="col-xs-6 col-sm-2">
                            <label for="Matricula">Mátrícula</label>
                            @Html.EditorFor(model => model.MatUsuario, new { htmlAttributes = new { @disabled = "disabled", @class = "form-control col-md-8", @placeholder = "Matrícula" } })
                            <span asp-validation-for="MatUsuario" class="text-danger"></span>
                        </div>
                        <div class="col-xs-6 col-sm-4">
                            <label for="NomeUser">Nome</label>
                            @Html.EditorFor(model => model.NomeUsuario, new { htmlAttributes = new { @disabled = "disabled", @class = "form-control col-md-18", @placeholder = "Nome" } })
                            <span asp-validation-for="NomeUsuario" class="text-danger"></span>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-xs-6 col-sm-2">
                            <label for="NomeGerencia">
                                Centro de Custo
                            </label>
                            @Html.EditorFor(model => model.Coordenacao, new { htmlAttributes = new { @disabled = "disabled", @class = "form-control col-md-8", @placeholder = "Coordenacao" } })
                            <span asp-validation-for="Coordenacao" class="text-danger"></span>
                        </div>
                        <div class="col-xs-6 col-sm-2">
                            <label for="DataDia">
                                Data da marcação
                            </label>
                            @Html.EditorFor(model => model.DataDia, new { htmlAttributes = new { @id = "DateSelect", @class = "form-control", @type = "date" } })
                            <span asp-validation-for="DataDia" class="text-danger"></span>
                        </div>
                    </div>
                    <br />
                    <div class="card azulc-azule">
                        <div class="card-header">
                            Batidas do Relógio de Ponto
                        </div>
                        <div class="card-body">
                            <table id="tbCabecalhoMarcacao" class="table table-striped table-bordered table-hover responsive nowrap" cellspacing="0" width="100%">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card azulc-azule">
                        <div class="card-header">
                            Lançamento de Marcações
                        </div>
                        <div class="card-body">
                            <table id="tbLancamento" class="table table-striped table-bordered table-hover responsive nowrap" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th>Hora Início</th>
                                        <th>Hora Fim</th>
                                        <th>Projeto</th>
                                        <th>Observação</th>
                                        <th>Código Divergência</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div id="sucesso" style="display:none" class="card">
        <div class="body">
            <div class="alert alert-success">
                <strong id="strong">Lancamento realizado com sucesso!</strong>
            </div>
        </div>
    </div>
    <div id="erro" style="display:none" class="card">
        <div class="alert alert-danger">
            <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ops!  </font></font></strong><font style="vertical-align: inherit;">
                <font id="erromsg" style="vertical-align: inherit;">
                </font>
            </font>
        </div>
    </div>
    <div id="myModal" class="modal fade" role="dialog">
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="btn-ft">
        <input type="checkbox" href="#" class="btn-ft-open" name="btn-ft-open" id="btn-ft-open" />
        <label class="btn-ft-item-open" for="btn-ft-open">
            <span><i class="fas fa-plus"></i></span>
        </label>
        <button type="button" id="salvar" class="btn-ft-item" tooltip="Salvar"><i class="fas fa-save"></i></button>
        <button type="button" style="display:none" id="salvarEdicao" class="btn-ft-item" tooltip="Salvar Edição"><i class="fas fa-save"></i></button>
        <a href="@Url.Action("Index", "Marcacao")" class="btn-ft-item" tooltip="Voltar"><i class="fas fa-arrow-left"></i></a>
        <a onclick="Create()" class="btn-ft-item" tooltip="Novo Lançamento"><i class="fas fa-plus"></i></a>
    </div>
}

<script type="text/javascript">
    $.fn.scrollView = function () {
        return this.each(function () {
            $('html, body').animate({
                scrollTop: $(this).offset().top
            }, 1000);
        });
    }


    function Create() {
        document.getElementById("salvar").style.display = 'block';
        document.getElementById("salvarEdicao").style.display = 'none';
        var inputText = $('#DateSelect').val();
        if (inputText !== undefined) {
            if (inputText != '') {

                $("#novaMarcacao").removeClass("is-invalid");
                $.ajax({
                    url: "/Lancamento/Index",
                    type: 'get'
                }).done(function (data) {
                    $("#modal-body").html(data);
                    $('#modal-body').scrollView();
                });

            } else {
                Information('A data da marcação não informada!');
            }
        } else {
            Information('Não foi carregado!');
        }
    }

    function edit(id, datalancamento) {
        document.getElementById("salvar").style.display = 'none';
        document.getElementById("salvarEdicao").style.display = 'block';
        var inputText = $('#DateSelect').val();
        if (inputText !== undefined) {
            if (inputText != '') {

                $("#novaMarcacao").removeClass("is-invalid");
                $.ajax({
                    url: "/Lancamento/Edit",
                    data: { data: datalancamento, seq: id },
                    type: 'get'
                }).done(function (data) {
                    $("#modal-body").html(data);
                    $('#modal-body').scrollView();
                });

            } else {
                Information('A data da marcação não informada!');
            }
        } else {
            Information('Não foi carregado!');
        }
    }

    function Delete(id) {
        $("#myModal").dialog({
            resizable: false,
            height: 140,
            title: "Exclusão de Lancamento",
            modal: true,
            buttons: {
                "Excluir": function () {
                    ExcluirRegistroLancamento(id);
                    $(this).dialog("close");
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            }
        });

    }

    var onSelect = function (dateText) {
         limparCampos();
        if ($("#DateSelect").val().length == 10) {
            $.ajax({
                url: '@Url.Action("ListApontamento", "Marcacao")',
                changeMonth: true,
                changeYear: true,
                dataType: 'json',
                type: 'get',
                data: { data: $("#DateSelect").val() },
                success: function (data) {
                    if (data.erro != undefined) {
                        Information(data.msg);
                    } else {
                        $('#tbCabecalhoMarcacao tbody td').remove();
                        for (var i = 0; data.length > i; i++) {
                            $('#tbCabecalhoMarcacao tbody').append('<td>' + data[i].apontamento + '</td>' +
                                '</td><td class="actions col-xs-2 align="center">');

                        }
                        ObterListaLancamento();
                    }
                }
            });
        }
    }


    $("#salvar").on("click", function (event) {

        $.ajax({
            type: "post",
            dataType: 'json',
            url: '../Marcacao/Create',
            data: $('form').serialize()
        })
            .done(function (data) {
                if (data.erro === true) {
                    document.getElementById("sucesso").style.display = 'none';
                    document.getElementById("erro").style.display = 'block';
                    $('#erromsg').text(data.msg);
                } else {
                    document.getElementById("erro").style.display = 'none';
                    document.getElementById("sucesso").style.display = 'block';
                    $('#strong').text(data.sucesso);
                    ObterListaLancamento();
                    limparCampos();
              }

            })
            .fail(function (data) {
                Danger(data.msg)
            });
        event.preventDefault();
    });

    $("#salvarEdicao").on("click", function (event) {
        $.ajax({
            type: "post",
            dataType: 'json',
            url: '../Marcacao/Edit',
            data: $('form').serialize()
        })
            .done(function (data) {
                if (data.erro === true) {
                    document.getElementById("sucesso").style.display = 'none';
                    document.getElementById("erro").style.display = 'block';
                    $('#erromsg').text(data.msg);
                } else {
                    document.getElementById("erro").style.display = 'none';
                    document.getElementById("sucesso").style.display = 'block';
                    $('#strong').text(data.sucesso);
                    ObterListaLancamento();
                    limparCampos();
                }
            })
            .fail(function (data) {
                Danger(data.msg)
            });
        event.preventDefault();
    });


    $("#DateSelect").on('change', onSelect);


    function ObterListaLancamento() {
          $.ajax({
                url: '@Url.Action("GetMarcacoes", "Marcacao")',
                changeMonth: true,
                changeYear: true,
                dataType: 'json',
                type: 'get',
                data: { data: $("#DateSelect").val() },
                success: function (data) {
                    $('#tbLancamento tbody tr').remove();
                    for (var i = 0; data.length > i; i++) {
                        $('#tbLancamento tbody').append('<tr><td>' + data[i].horaInicio + '</td>' +
                            '<td>' + data[i].horaFim + '</td>' +
                            '<td>' + data[i].descricaoEmp + '</td>' +
                            '<td>' + data[i].observacao + '</td>' +
                            '<td>' + data[i].codDivergencia + '</td>' +
                            '<td>' +
                            '<button type="button" class="btn btn-sm btn-visualizar" name="visualizar" onclick=location.href="/Lancamento/Delete/' + data[i].seq + '"><i class="fas fa-eye"></i></button>' +
                            '<button type="button" class="btn btn-sm btn-editar" name="editar" onclick="edit(' + data[i].seq + ','+data[i].dateLancamento +')"><i class="fas fa-pen"></i></button>' +
                            '<button type="button" class="btn btn-sm create"  onclick="Delete('+ data[i].seq +')"><i class="fas fa-trash"></i></button>' +
                            '</td></tr>');
                    }
                }
            });
    }

    function limparCampos() {
        document.getElementById("sucesso").style.display = 'none';
        document.getElementById("erro").style.display = 'none';
        $('#Lancamento_HoraInicio').val("");
        $('#Lancamento_HoraFim').val("");
        $('#Lancamento_HoraFim').val("");
        $('#nomeEmpreendimento').val("");
        $('#Lancamento_EmpreendimentoIds').empty();
        $('#comentario').val("");
        $('#searchInput').val("");
        document.getElementById("salvar").style.display = 'block';
        document.getElementById("salvarEdicao").style.display = 'none';

    }

    function ExcluirRegistroLancamento(seq) {
        $.ajax({
            type: "post",
            dataType: 'json',
            url: '/Lancamento/Excluir',
            data: { seq: seq }
        })
            .done(function (data) {
                if (data.erro === true) {
                    document.getElementById("sucesso").style.display = 'none';
                    document.getElementById("erro").style.display = 'block';
                    $('#erromsg').text(data.msg);
                } else {
                    document.getElementById("erro").style.display = 'none';
                    document.getElementById("sucesso").style.display = 'block';
                    $('#strong').text(data.sucesso);
                    ObterListaLancamento();
                    limparCampos();
                }
            })
            .fail(function (data) {
                Danger(data.msg)
            });
        event.preventDefault();
    }

</script>